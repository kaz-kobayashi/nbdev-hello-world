<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>nbdev-hello-world - 施設配置問題</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="nbdev-hello-world - 施設配置問題">
<meta property="og:description" content="">
<meta property="og:image" content="https://kaz-kobayashi.github.io/nbdev-hello-world/03_facloc_files/figure-html/cell-10-output-2.png">
<meta property="og:site-name" content="nbdev-hello-world">
<meta property="og:image:height" content="355">
<meta property="og:image:width" content="565">
<meta name="twitter:title" content="nbdev-hello-world - 施設配置問題">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://kaz-kobayashi.github.io/nbdev-hello-world/03_facloc_files/figure-html/cell-10-output-2.png">
<meta name="twitter:image-height" content="355">
<meta name="twitter:image-width" content="565">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">nbdev-hello-world</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./facloc.html">施設配置問題</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">nbdev-hello-world</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./core.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">notacore</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./gis-density.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">人口密度のプロット</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./facloc.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">施設配置問題</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./shortestpath.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">最短路問題</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">施設配置問題</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>施設配置問題は，候補地の中からある目的関数を最適化するように実際に施設を配置する場所を選び出す問題である。施設配置問題を知るのに適切な文献として，<a href="https://www.jstage.jst.go.jp/article/bjsiam/23/4/23_KJ00008992858/_article/-char/ja/">田中健一，数理最適化入門(4) : 施設配置の数理モデル(チュートリアル)，応用数理23(4),2013</a>が挙げられる。</p>
<p>施設配置問題を定めるには，需要点の集合<span class="math inline">\(I\)</span>と，配置候補地<span class="math inline">\(J\)</span>を定義する。そして，需要点<span class="math inline">\(i \in I\)</span>から<span class="math inline">\(j \in J\)</span>への移動距離<span class="math inline">\(d_{ij}\)</span>が与えられるとする。さらに，需要点<span class="math inline">\(i\)</span>の需要量<span class="math inline">\(w_i\)</span>が与えられるとする。</p>
<p>また，配置候補地<span class="math inline">\(j \in J\)</span>に対して0-1変数<span class="math inline">\(x_j\)</span>を導入する。候補地<span class="math inline">\(j \in J\)</span>に施設を配置すること1，そうでないとき0をとる変数とする。そして，<span class="math inline">\(i \in I\)</span>と<span class="math inline">\(j \in J\)</span>の各ペアに対して，変数<span class="math inline">\(y_{ij}\)</span>を定義する。この変数は，需要<span class="math inline">\(i\)</span>を施設<span class="math inline">\(j\)</span>に配置するとき1，そうでないとき0となる。</p>
<p>施設配置問題の目的関数は，各需要点から，その需要点に割り当てられた施設への移動距離の重み付き和<span class="math inline">\(\sum_{i \in I}\sum_{j \in J}w_id_{ij}y_{ij}\)</span>とする。</p>
<p>制約条件としては，</p>
<ul>
<li>配置する施設数がちょうど<span class="math inline">\(p\)</span>個となる制約:</li>
</ul>
<p><span class="math display">\[
\sum_{j \in J}x_j=p
\]</span></p>
<ul>
<li>各需要点がちょうど1つの施設に割り当てられることを課す制約</li>
</ul>
<p><span class="math display">\[
\sum_{j \in J}y_{ij}=1 \ \ \forall i  \in I
\]</span></p>
<ul>
<li>需要点<span class="math inline">\(i\)</span>が施設<span class="math inline">\(j\)</span>に割り当てられるには施設<span class="math inline">\(j\)</span>が配置されている必要があることを課す制約</li>
</ul>
<p><span class="math display">\[
y_{ij} \leq x_j \ \ \forall i  \in I,\ \forall j  \in J
\]</span></p>
<p>を課す。まとめると，施設配置問題は，次の整数計画問題として定式化される。</p>
<p><span class="math display">\[
\begin{array}{lll}
\min&amp;\displaystyle \sum_{i  \in I}\sum_{j \in J}w_id_{ij}y_{ij}&amp;\\
\text{s.t.}&amp;\displaystyle\sum_{j \in J }x_j=p&amp;\\
&amp;\displaystyle\sum_{j\in J}y_{ij}=1&amp;\ \forall i  \in I\\
&amp;y_{ij}\leq\ x_j&amp;\ \forall i  \in I\ \forall j  \in J\\
&amp;x_j\in\{0,1\}&amp;\ \forall j \in J\\
&amp;y_{ij}\in\{0,1\}&amp;\ \forall i \in I,\forall j \in J.
\end{array}
\]</span></p>
<p>この整数計画問題を解くためのプログラムを定める。まず，集合<span class="math inline">\(I,J\)</span>，<span class="math inline">\(w_i\)</span>，<span class="math inline">\(d_{ij}\)</span>，<span class="math inline">\(p\)</span>を定めるリストと辞書を定義する。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#需要点の集合の定義</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>I<span class="op">=</span>[<span class="dv">0</span>,<span class="dv">1</span>]</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">#配置候補地の集合</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>J<span class="op">=</span>[<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>]</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">#需要量の定義</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>w<span class="op">=</span>{<span class="dv">0</span>:<span class="dv">10</span>,<span class="dv">1</span>:<span class="dv">15</span>,<span class="dv">2</span>:<span class="dv">7</span>,<span class="dv">3</span>:<span class="dv">9</span>,<span class="dv">4</span>:<span class="dv">12</span>}</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">#施設数の定義</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>p<span class="op">=</span><span class="dv">2</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># costsの定義</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>costs <span class="op">=</span> {</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">0</span>, <span class="dv">0</span>): <span class="dv">4</span>,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">0</span>, <span class="dv">1</span>): <span class="dv">6</span>,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">0</span>, <span class="dv">2</span>): <span class="dv">9</span>,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">0</span>, <span class="dv">3</span>): <span class="dv">8</span>,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">0</span>, <span class="dv">4</span>): <span class="dv">7</span>,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="dv">0</span>): <span class="dv">5</span>,</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="dv">1</span>): <span class="dv">8</span>,</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="dv">2</span>): <span class="dv">7</span>,</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="dv">3</span>): <span class="dv">6</span>,</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="dv">4</span>): <span class="dv">4</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>これらを用いて施設配置問題を解く関数<code>facilitylocation()</code>を定める。</p>
<div class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pulp <span class="im">import</span> <span class="op">*</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> facilitylocation(I,J,w,costs,p):</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 空の線形計画問題を生成する</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    prob <span class="op">=</span> LpProblem(<span class="st">"FacilityLocation"</span>, LpMinimize)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 決定変数を定める</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>LpVariable.dicts(<span class="st">"y"</span>,[(i,j) <span class="cf">for</span> i <span class="kw">in</span> I <span class="cf">for</span> j <span class="kw">in</span> J],cat<span class="op">=</span><span class="st">'Binary'</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>LpVariable.dicts(<span class="st">"x"</span>,[j <span class="cf">for</span> j <span class="kw">in</span> J],cat<span class="op">=</span><span class="st">'Binary'</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 目的関数の定義</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    prob <span class="op">+=</span> lpSum([w[i]<span class="op">*</span>costs[(i, j)] <span class="op">*</span> y[(i, j)] <span class="cf">for</span> j <span class="kw">in</span> J] <span class="cf">for</span> i <span class="kw">in</span> I)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 制約条件の定義</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    prob<span class="op">+=</span>lpSum([x[j] <span class="cf">for</span> j <span class="kw">in</span> J])<span class="op">==</span>p</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> I:</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>        prob<span class="op">+=</span>lpSum([y[(i,j)] <span class="cf">for</span> j <span class="kw">in</span> J])<span class="op">==</span><span class="dv">1</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> I:</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> J:</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>            prob<span class="op">+=</span>y[(i,j)]<span class="op">&lt;=</span>x[j]</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 最適化の実行</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    prob.solve()<span class="op">;</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print the results</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Status:"</span>, LpStatus[prob.status])</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> v <span class="kw">in</span> prob.variables():</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(v.name, <span class="st">"="</span>, v.varValue)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Total Cost = "</span>, value(prob.objective))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>こうして定義した関数を用いて配置する施設と，各需要点の施設への割り当てを求める。</p>
<div class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>facilitylocation(I,J,w,costs,p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Welcome to the CBC MILP Solver 
Version: 2.10.10 
Build Date: Apr 19 2023 

command line - cbc /var/folders/w6/pzry98n55l31dnvgymbwt9jh0000gn/T/8b46036933744d2db5bb7156cf4f5a18-pulp.mps timeMode elapsed branch printingOptions all solution /var/folders/w6/pzry98n55l31dnvgymbwt9jh0000gn/T/8b46036933744d2db5bb7156cf4f5a18-pulp.sol (default strategy 1)
At line 2 NAME          MODEL
At line 3 ROWS
At line 18 COLUMNS
At line 94 RHS
At line 108 BOUNDS
At line 124 ENDATA
Problem MODEL has 13 rows, 15 columns and 35 elements
Coin0008I MODEL read with 0 errors
Option for timeMode changed from cpu to elapsed
Continuous objective value is 100 - 0.00 seconds
Cgl0004I processed model has 13 rows, 15 columns (15 integer (15 of which binary)) and 35 elements
Cutoff increment increased from 1e-05 to 4.9999
Cbc0038I Initial state - 0 integers unsatisfied sum - 0
Cbc0038I Solution found of 100
Cbc0038I Before mini branch and bound, 15 integers at bound fixed and 0 continuous
Cbc0038I Mini branch and bound did not improve solution (0.00 seconds)
Cbc0038I After 0.00 seconds - Feasibility pump exiting with objective of 100 - took 0.00 seconds
Cbc0012I Integer solution of 100 found by feasibility pump after 0 iterations and 0 nodes (0.00 seconds)
Cbc0001I Search completed - best objective 100, took 0 iterations and 0 nodes (0.00 seconds)
Cbc0035I Maximum depth 0, 0 variables fixed on reduced cost
Cuts at root node changed objective from 100 to 100
Probing was tried 0 times and created 0 cuts of which 0 were active after adding rounds of cuts (0.000 seconds)
Gomory was tried 0 times and created 0 cuts of which 0 were active after adding rounds of cuts (0.000 seconds)
Knapsack was tried 0 times and created 0 cuts of which 0 were active after adding rounds of cuts (0.000 seconds)
Clique was tried 0 times and created 0 cuts of which 0 were active after adding rounds of cuts (0.000 seconds)
MixedIntegerRounding2 was tried 0 times and created 0 cuts of which 0 were active after adding rounds of cuts (0.000 seconds)
FlowCover was tried 0 times and created 0 cuts of which 0 were active after adding rounds of cuts (0.000 seconds)
TwoMirCuts was tried 0 times and created 0 cuts of which 0 were active after adding rounds of cuts (0.000 seconds)
ZeroHalf was tried 0 times and created 0 cuts of which 0 were active after adding rounds of cuts (0.000 seconds)

Result - Optimal solution found

Objective value:                100.00000000
Enumerated nodes:               0
Total iterations:               0
Time (CPU seconds):             0.00
Time (Wallclock seconds):       0.00

Option for printingOptions changed from normal to all
Total time (CPU seconds):       0.00   (Wallclock seconds):       0.00

Status: Optimal
x_0 = 1.0
x_1 = 0.0
x_2 = 0.0
x_3 = 0.0
x_4 = 1.0
y_(0,_0) = 1.0
y_(0,_1) = 0.0
y_(0,_2) = 0.0
y_(0,_3) = 0.0
y_(0,_4) = 0.0
y_(1,_0) = 0.0
y_(1,_1) = 0.0
y_(1,_2) = 0.0
y_(1,_3) = 0.0
y_(1,_4) = 1.0
Total Cost =  100.0</code></pre>
</div>
</div>
<p>この出力結果から，最適解が求まったことがわかる。配置する施設は0と4であり，需要点0は施設0に，需要点1は施設4に掘り当てることが最適であることがわかる。また，その時の目的関数値は100であることもわかる。</p>
<p>実際の地理情報を用いた例</p>
<p><a href="https://nlftp.mlit.go.jp/ksj/">国土数値情報ダウンロードサイト</a>から，<a href="https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-P04-v3_0.html">医療機関データ</a>をダウンロードする。</p>
<p>ここのリストから，神奈川，世界測地系，令和2年のデータである，P04-20_13_GML.zipをダウンロードする。</p>
<p>ダウンロードしたファイルを解凍して，得られたフォルダを<code>data</code>フォルダに収める。</p>
<p>こうして得たファイルを，<code>geopandas</code>の<code>read_file()</code>により読み込む。</p>
<div class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>hosp<span class="op">=</span>gpd.read_file(<span class="st">'data/P04-20_13_GML/P04-20_13.geojson'</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>hosp.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="58">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">P04_001</th>
<th data-quarto-table-cell-role="th">P04_002</th>
<th data-quarto-table-cell-role="th">P04_003</th>
<th data-quarto-table-cell-role="th">P04_004</th>
<th data-quarto-table-cell-role="th">P04_005</th>
<th data-quarto-table-cell-role="th">P04_006</th>
<th data-quarto-table-cell-role="th">P04_007</th>
<th data-quarto-table-cell-role="th">P04_008</th>
<th data-quarto-table-cell-role="th">P04_009</th>
<th data-quarto-table-cell-role="th">P04_010</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>3</td>
<td>キタカタ歯科医院</td>
<td>江戸川区南篠崎町3-3-1　スイートヒルズ瑞江1階</td>
<td>歯</td>
<td>NaN</td>
<td>NaN</td>
<td>9</td>
<td>0</td>
<td>9</td>
<td>9</td>
<td>POINT (139.90021 35.69387)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>3</td>
<td>スギタ歯科篠崎診療室</td>
<td>江戸川区上篠崎2-4-3</td>
<td>歯　小歯　矯歯　口外</td>
<td>NaN</td>
<td>NaN</td>
<td>9</td>
<td>0</td>
<td>9</td>
<td>9</td>
<td>POINT (139.90121 35.71164)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2</td>
<td>江戸川区葛西健康サポ-トセンタ-</td>
<td>江戸川区中葛西3-10-1</td>
<td>内　小　歯</td>
<td>NaN</td>
<td>NaN</td>
<td>9</td>
<td>0</td>
<td>9</td>
<td>9</td>
<td>POINT (139.86965 35.66591)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2</td>
<td>江戸川区江戸川保健所</td>
<td>江戸川区中央4-24-19</td>
<td>内　小　歯</td>
<td>NaN</td>
<td>NaN</td>
<td>9</td>
<td>0</td>
<td>9</td>
<td>9</td>
<td>POINT (139.86835 35.70958)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>3</td>
<td>西葛西ファミリー歯科</td>
<td>江戸川区西葛西3-9-19　イオン葛西店4階</td>
<td>歯　小歯　口外　矯歯</td>
<td>NaN</td>
<td>NaN</td>
<td>9</td>
<td>0</td>
<td>9</td>
<td>9</td>
<td>POINT (139.85850 35.66924)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>このデータのうち，<code>P04_001</code>列に，医療機関の分類を示す値が含まれている。これが1なら病院，2なら診療所，3なら歯科診療所であることを示す。この列の値が1であるものを抜き出し，あらためてhospというデータにする。</p>
<div class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>hosp<span class="op">=</span>hosp[hosp[<span class="st">"P04_001"</span>]<span class="op">==</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>hosp</code>の先頭の5行を表示して確かに病院が抜き出されていることを確認する。</p>
<div class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>hosp.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="60">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">P04_001</th>
<th data-quarto-table-cell-role="th">P04_002</th>
<th data-quarto-table-cell-role="th">P04_003</th>
<th data-quarto-table-cell-role="th">P04_004</th>
<th data-quarto-table-cell-role="th">P04_005</th>
<th data-quarto-table-cell-role="th">P04_006</th>
<th data-quarto-table-cell-role="th">P04_007</th>
<th data-quarto-table-cell-role="th">P04_008</th>
<th data-quarto-table-cell-role="th">P04_009</th>
<th data-quarto-table-cell-role="th">P04_010</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">81</td>
<td>1</td>
<td>３６６リハビリテーション病院</td>
<td>府中市住吉町1-34-6</td>
<td>リハビリ科</td>
<td>NaN</td>
<td>NaN</td>
<td>4</td>
<td>68</td>
<td>9</td>
<td>9</td>
<td>POINT (139.45764 35.66162)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">225</td>
<td>1</td>
<td>ＪＲ東京総合病院</td>
<td>渋谷区代々木2-1-3</td>
<td>内科　呼吸器内科　循環器内科　消化器内科　脳神経内科　糖尿病内分泌内科　血液腫瘍内科　リウマ...</td>
<td>放射線科　麻酔科　ペイン外科　臨床検査科　救急科　皮膚科　歯科口腔外科　病理診断科　血管外科</td>
<td>NaN</td>
<td>6</td>
<td>425</td>
<td>1</td>
<td>9</td>
<td>POINT (139.69977 35.68569)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">317</td>
<td>1</td>
<td>ＮＴＴ東日本関東病院</td>
<td>品川区東五反田5-9-22</td>
<td>内科　呼吸器内科　循環器内科　小児科　精神科　外科　整形外科　脳神経外科　心臓血管外科　産婦...</td>
<td>腎臓内科　感染症内科　緩和ケア内科　脳神経内科　脳　血管内科　乳腺外科　呼吸器外科　頭頸部外...</td>
<td>NaN</td>
<td>6</td>
<td>594</td>
<td>1</td>
<td>2</td>
<td>POINT (139.72554 35.63129)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">587</td>
<td>1</td>
<td>あきしま相互病院</td>
<td>昭島市もくせいの杜2-2-1</td>
<td>内科　精神科　リハビリ科</td>
<td>NaN</td>
<td>NaN</td>
<td>4</td>
<td>110</td>
<td>9</td>
<td>9</td>
<td>POINT (139.38428 35.71871)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">644</td>
<td>1</td>
<td>あけぼの病院</td>
<td>町田市中町1-23-3</td>
<td>内科　循環器内科　腎臓内科　人工透析内科　糖尿病内分泌内科　ペイン内科　外科　消化器外科　大...</td>
<td>NaN</td>
<td>NaN</td>
<td>4</td>
<td>98</td>
<td>1</td>
<td>9</td>
<td>POINT (139.44508 35.54962)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>これから，特に町田市内の病院に注目する。そこで，東京都の<a href="https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-N03-v3_1.html">行政区域を示すデータ</a>をダウンロードし，町田市の行政区域コード13209を用いて町田市のデータを取り出す。ダウンロードするのは，世界測地系，令和5年のデータである，N03-20230101_13_GMP.zipとする。</p>
<div class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>tokyo<span class="op">=</span>gpd.read_file(<span class="st">'data/N03-20230101_13_GML/N03-23_13_230101.geojson'</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>machida<span class="op">=</span>tokyo[tokyo[<span class="st">"N03_007"</span>]<span class="op">==</span><span class="st">'13209'</span>].copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>得られた<code>machida</code>をプロットして，確かに町田市の行政区域であることを確認する。</p>
<div class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>machida.plot()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="65">
<pre><code>&lt;Axes: &gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="03_facloc_files/figure-html/cell-10-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>町田市内の病院を，<code>geopandas</code>の<code>sjoin</code>という演算を用いて取り出す。<code>how="inner"</code>を指定することで，<code>sjoin()</code>の最初の引数<code>hosp</code>からデータを取り出す。同時に，<code>op="within"</code>を指定することで，<code>machida</code>の区域（多角形）に含まれる<code>hosp</code>の行を取り出す。</p>
<div class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>hosp_in_machida<span class="op">=</span>gpd.sjoin(hosp,machida,how<span class="op">=</span><span class="st">"inner"</span>,op<span class="op">=</span><span class="st">"within"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/kazuhiro/miniconda3/envs/nbdev/lib/python3.11/site-packages/IPython/core/interactiveshell.py:3448: FutureWarning: The `op` parameter is deprecated and will be removed in a future release. Please use the `predicate` parameter instead.
  if await self.run_code(code, result, async_=asy):</code></pre>
</div>
</div>
<p><code>hosp_in_machida</code>の列のなかから，必要なものだけを抜き出したものを，あらためて<code>hosp_in_machida</code>とする。</p>
<div class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>hosp_in_machida<span class="op">=</span>hosp_in_machida[[<span class="st">'P04_001'</span>,<span class="st">'P04_002'</span>,<span class="st">'P04_003'</span>,<span class="st">'P04_004'</span>,<span class="st">'P04_008'</span>,<span class="st">'P04_009'</span>,<span class="st">'P04_010'</span>,<span class="st">'geometry'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>さらに，救急告示病院を抜き出したものを，<code>em_hosp</code>とする。<code>P04_009</code>列が1であるものが，救急告示病院である。</p>
<div class="cell" data-execution_count="88">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>em_hosp<span class="op">=</span>hosp_in_machida[hosp_in_machida[<span class="st">"P04_009"</span>]<span class="op">==</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>抜き出したままだとindexが飛び飛びの値になっているので，この番号を<code>reset_index()</code>によって振り直す。</p>
<div class="cell" data-execution_count="90">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>em_hosp<span class="op">=</span>em_hosp.reset_index()</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>em_hosp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="90">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">index</th>
<th data-quarto-table-cell-role="th">P04_001</th>
<th data-quarto-table-cell-role="th">P04_002</th>
<th data-quarto-table-cell-role="th">P04_003</th>
<th data-quarto-table-cell-role="th">P04_004</th>
<th data-quarto-table-cell-role="th">P04_008</th>
<th data-quarto-table-cell-role="th">P04_009</th>
<th data-quarto-table-cell-role="th">P04_010</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>644</td>
<td>1</td>
<td>あけぼの病院</td>
<td>町田市中町1-23-3</td>
<td>内科　循環器内科　腎臓内科　人工透析内科　糖尿病内分泌内科　ペイン内科　外科　消化器外科　大...</td>
<td>98</td>
<td>1</td>
<td>9</td>
<td>POINT (139.44508 35.54962)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>4530</td>
<td>1</td>
<td>ふれあい町田ホスピタル</td>
<td>町田市小山ヶ丘1-3-8</td>
<td>内科　循環器内科　人工透析内科　神経内科　皮膚科　精神科　消化器外科　泌尿器科　脳神経外科　...</td>
<td>199</td>
<td>1</td>
<td>9</td>
<td>POINT (139.38273 35.59798)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>6509</td>
<td>1</td>
<td>医療法人社団　慶泉会　町田慶泉病院</td>
<td>町田市南町田2-1-47</td>
<td>内科　神経内科　外科　整形外科　泌尿器科　肛門外科　リハビリ科　麻酔科　血管外科　脳外科　腎臓内科</td>
<td>148</td>
<td>1</td>
<td>9</td>
<td>POINT (139.47072 35.52103)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>6599</td>
<td>1</td>
<td>医療法人社団　幸隆会　多摩丘陵病院</td>
<td>町田市下小山田町1491</td>
<td>内科　外科　消化器外科　整形外科　脳神経外科　婦人科　眼科　泌尿器科　リハビリ科　麻酔科　歯...</td>
<td>316</td>
<td>1</td>
<td>9</td>
<td>POINT (139.42167 35.60461)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>6681</td>
<td>1</td>
<td>医療法人社団　三医会　鶴川記念病院</td>
<td>町田市三輪町1059-1</td>
<td>内科　小児科　リハビリ科</td>
<td>180</td>
<td>1</td>
<td>9</td>
<td>POINT (139.49661 35.57220)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>7085</td>
<td>1</td>
<td>医療法人社団　創生会　町田病院</td>
<td>町田市木曽東4-21-43</td>
<td>内科　胃腸科　循環器科　精神科　神経科　外科　整形外科　脳神経外科　皮膚科　リハビリ科　救急...</td>
<td>120</td>
<td>1</td>
<td>9</td>
<td>POINT (139.42529 35.56538)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>17133</td>
<td>1</td>
<td>社会医療法人社団　正志会　南町田病院</td>
<td>町田市鶴間4-4-1</td>
<td>内科　呼吸器内科　消化器内科　循環器内科　神経内科　小児科　外科　呼吸器外科　消化器外科　乳...</td>
<td>222</td>
<td>1</td>
<td>2</td>
<td>POINT (139.47121 35.50702)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>21336</td>
<td>1</td>
<td>町田市民病院</td>
<td>町田市旭町2-15-41</td>
<td>内科　小児科　精神科　アレルギー科　リウマチ科　外科　整形外科　形成外科　脳神経外科　心臓血...</td>
<td>447</td>
<td>1</td>
<td>2</td>
<td>POINT (139.43859 35.55705)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>得られた病院を，町田市の行政区域データと重ねて図示する。</p>
<div class="cell" data-execution_count="91">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>fig,ax<span class="op">=</span>plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">6</span>))</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>machida.plot(ax<span class="op">=</span>ax,color<span class="op">=</span><span class="st">"white"</span>,edgecolor<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>em_hosp.plot(ax<span class="op">=</span>ax,color<span class="op">=</span><span class="st">"blue"</span>,edgecolor<span class="op">=</span><span class="st">"black"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="91">
<pre><code>&lt;Axes: &gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="03_facloc_files/figure-html/cell-15-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>次に，町田市内の各地域の人口データを用いて，各地域の病院の需要を設定する。まず，東京都の人口データをダウンロードする。<a href="https://nlftp.mlit.go.jp/ksj/index.html">国土数値情報ダウンロードサイト</a>の「5.各種統計」の1kmメッシュ別将来推計人口データをダウンロードする。</p>
<p>これは，世界測地系，平成30年のデータであり，ファイル名は，<code>1km_mesh_suikei_2018_shape_13.zip</code>である。これを展開して，<code>data</code>フォルダに移動する。</p>
<p>この中のshapefileを読み込み，<code>SHICODE</code>列（行政区域コード）が13209（町田市）のものを抜き出して，<code>machida_pop</code>とする。</p>
<div class="cell" data-execution_count="87">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>pop<span class="op">=</span>gpd.read_file(<span class="st">"data/1km_mesh_suikei_2018_shape_13/1km_mesh_2018_13.shp"</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>machida_pop<span class="op">=</span>pop[pop[<span class="st">"SHICODE"</span>]<span class="op">==</span><span class="dv">13209</span>].copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>machida_pop.plot()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="78">
<pre><code>&lt;Axes: &gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="03_facloc_files/figure-html/cell-17-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>1kmメッシュの重点を求めるために，座標系をEPSG:2451とする。この2451は，距離が正しく測れる座標系の一つである。座標系を変換した後に<code>machida_pop.centroid</code>によって各メッシュ（各行）のgeometryの重心を求めて，それを改めて<code>machida_pop</code>の<code>centroid</code>列に覚えておく。</p>
<div class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>machida_pop<span class="op">=</span>machida_pop.to_crs(epsg<span class="op">=</span><span class="dv">2451</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>machida_pop[<span class="st">"centroid"</span>]<span class="op">=</span>machida_pop[<span class="st">"geometry"</span>].centroid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>machida_pop</code>の<code>centroid</code>列を，<code>machida_pop</code>の<code>geometry</code>として設定する。このために，<code>set_geometry()</code>を用いる。</p>
<div class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>machida_pop.set_geometry(<span class="st">"centroid"</span>,inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>machida_pop.plot()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="84">
<pre><code>&lt;Axes: &gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="03_facloc_files/figure-html/cell-19-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="82">
<pre><code>&lt;Axes: &gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="03_facloc_files/figure-html/cell-20-output-2.png" class="img-fluid"></p>
</div>
</div>



</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/kaz-kobayashi/nbdev-hello-world/issues/new" class="toc-action">Report an issue</a></p></div></div></div></div></footer></body></html>